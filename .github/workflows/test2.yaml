# name: Deployment and validation to production
# on:
#   push:
#     branches:
#       - feature
#       - main
#   pull_request:
#     branches:
#       - main

# jobs:

#   #runs validation when pull request is raised
#   Validation:
#     if: github.event_name == 'pull_request'
#     runs-on: ubuntu-latest
#    # environment: UAT

#     steps:
#       - uses: actions/setup-node@v3
#         with:
#           node-version: '18'
#       - name: 'Checkout source code'
#         uses: actions/checkout@v3
#         with:
#           fetch-depth: '2'

#       - name: 'Install sfdx'
#         run: npm install @salesforce/cli --global

#       - name: 'Installing sfdx git delta'
#         run: | 
#           echo Y | sfdx plugins:install sfdx-git-delta
#           sfdx plugins

#       - name: 'Create delta packages'
#         run: | 
#           mkdir changed-sources
#           sf sgd source delta --to "HEAD" --from "HEAD~1" --output changed-sources/ --generate-delta --source force-app/
#           echo "[INFO] Diff generated"  

#       - name: 'Deploy to environment with running all local tests'
#         run: |
#           echo "${{ secrets.JWT_SERVER_KEY }}" > server.key
#           sf org login jwt --username ${{ secrets.DEPLOYMENT_USER_NAME }} --jwt-key-file server.key --client-id ${{ secrets.CONSUMER_KEY }} --instance-url ${{ vars.INSTANCE_URL }} --set-default
#           sf project deploy start \
#           --source-dir changed-sources/force-app \
#           --test-level RunLocalTests \
#           --dry-run

#   # runs when pull request is resolved and merged 
#   Deployment:
#     if: github.event_name == 'push' && github.ref == 'refs/heads/main'
#     runs-on: ubuntu-latest
#    # environment: UAT

#     steps:
#       - uses: actions/setup-node@v3
#         with:
#           node-version: '18'
#       - name: 'Checkout source code'
#         uses: actions/checkout@v3
#         with:
#           fetch-depth: '2'

#       - name: 'Install sfdx'
#         run: npm install @salesforce/cli --global

#       - name: 'Installing sfdx git delta'
#         run: | 
#           echo Y | sfdx plugins:install sfdx-git-delta
#           sfdx plugins

#       - name: 'Create delta packages'
#         run: | 
#           mkdir changed-sources
#           sf sgd source delta --to "HEAD" --from "HEAD~1" --output changed-sources/ --generate-delta --source force-app/
#           echo "[INFO] Diff generated"  

#       - name: 'Deploy to environment with running all local tests'
#         run: |
#           echo "${{ secrets.JWT_SERVER_KEY }}" > server.key
#           sf org login jwt --username ${{ secrets.DEPLOYMENT_USER_NAME }} --jwt-key-file server.key --client-id ${{ secrets.CONSUMER_KEY }} --instance-url ${{ vars.INSTANCE_URL }} --set-default
#           sf project deploy start --source-dir changed-sources/force-app --test-level RunLocalTests




# name: Deploy to Uat environment on push to main

# on:
#   push:
#     branches: 
#       - feature
#       - main
#   pull_request:
#      branches: 
#       - main

# jobs:
#   validate-to-Uat-environment:
#       if: github.event_name == 'pull_request'
#       runs-on: ubuntu-latest
#       environment: UAT
#       steps:
#           - uses: actions/setup-node@v3
#             with:
#               node-version: '18'
#           - name: 'Checkout source code'
#             uses: actions/checkout@v3
#             with:
#               fetch-depth: '2'
                
#           # Now Install Salesforce CLI
#           - name: 'Install sfdx'
#             run: npm install @salesforce/cli --global
#           - name: 'Installing sfdx git delta'
#             run: | 
#                 echo Y | sfdx plugins:install sfdx-git-delta
#                 sfdx plugins

#           - name: 'Create delta packages'
#             run: | 
#                 mkdir changed-sources
#                 sf sgd source delta --to "HEAD" --from "HEAD~1" --output changed-sources/ --generate-delta --source force-app/
#                 echo "[INFO] Diff generated"
                
#           - name: 'Deploy to environment with running all local tests'
#             run: |
#                 echo "${{ secrets.JWT_SERVER_KEY }}" > server.key
#                 sf org login jwt --username ${{ secrets.DEPLOYMENT_USER_NAME }} --jwt-key-file server.key --client-id ${{ secrets.CONSUMER_KEY }} --instance-url ${{ vars.INSTANCE_URL }} --set-default
#                 sf project deploy validate --source-dir changed-sources/force-app --test-level RunLocalTests


#   Deploy-to-Uat-environment:
#       if: github.event_name == 'push' && github.ref == 'refs/heads/main'
#       runs-on: ubuntu-latest
#       environment: UAT
#       steps:
#           - uses: actions/setup-node@v3
#             with:
#               node-version: '18'
#           - name: 'Checkout source code'
#             uses: actions/checkout@v3
#             with:
#               fetch-depth: '2'
                
#           # Now Install Salesforce CLI
#           - name: 'Install sfdx'
#             run: npm install @salesforce/cli --global
#           - name: 'Installing sfdx git delta'
#             run: | 
#                 echo Y | sfdx plugins:install sfdx-git-delta
#                 sfdx plugins

#           - name: 'Create delta packages'
#             run: | 
#                 mkdir changed-sources
#                 sf sgd source delta --to "HEAD" --from "HEAD~1" --output changed-sources/ --generate-delta --source force-app/
#                 echo "[INFO] Diff generated"
                
#           - name: 'Deploy to environment with running all local tests'
#             run: |
#                 echo "${{ secrets.JWT_SERVER_KEY }}" > server.key
#                 sf org login jwt --username ${{ secrets.DEPLOYMENT_USER_NAME }} --jwt-key-file server.key --client-id ${{ secrets.CONSUMER_KEY }} --instance-url ${{ vars.INSTANCE_URL }} --set-default
#                 sf project deploy start --source-dir changed-sources/force-app --test-level RunLocalTests

# name: Deploy to UAT environment on push to main

# on:
#   push:
#     branches: 
#       - feature
#       - main
#   pull_request:
#     branches: 
#       - main

# jobs:

#   validate-to-Uat-environment:
#     if: github.event_name == 'pull_request'
#     runs-on: ubuntu-latest
#     environment: UAT

#     steps:
#       - uses: actions/setup-node@v3
#         with:
#           node-version: '18'

#       - name: Checkout source code
#         uses: actions/checkout@v3
#         with:
#           fetch-depth: '2'

#       - name: Install sfdx
#         run: npm install @salesforce/cli --global

#       - name: Installing sfdx git delta
#         run: |
#           echo Y | sfdx plugins:install sfdx-git-delta
#           sfdx plugins

#       - name: Create delta packages
#         run: |
#           mkdir changed-sources
#           sf sgd source delta --to "HEAD" --from "HEAD~1" --output changed-sources/ --generate-delta --source force-app/
#           echo "[INFO] Diff generated"
#           ls -R changed-sources

#       - name: Validate deployment
#         run: |
#           echo "${{ secrets.JWT_SERVER_KEY }}" > server.key
#           sf org login jwt --username ${{ secrets.DEPLOYMENT_USER_NAME }} --jwt-key-file server.key --client-id ${{ secrets.CONSUMER_KEY }} --instance-url ${{ vars.INSTANCE_URL }} --set-default
          
#           if [ -d "changed-sources/force-app" ]; then
#             sf project deploy validate --source-dir changed-sources/force-app --test-level RunLocalTests
#           else
#             echo "No metadata changes found — skipping validation."
#           fi


#   Deploy-to-Uat-environment:
#     if: github.event_name == 'push' && github.ref == 'refs/heads/main'
#     runs-on: ubuntu-latest
#     environment: UAT

#     steps:
#       - uses: actions/setup-node@v3
#         with:
#           node-version: '18'

#       - name: Checkout source code
#         uses: actions/checkout@v3
#         with:
#           fetch-depth: '2'

#       - name: Install sfdx
#         run: npm install @salesforce/cli --global

#       - name: Installing sfdx git delta
#         run: |
#           echo Y | sfdx plugins:install sfdx-git-delta
#           sfdx plugins

#       - name: Create delta packages
#         run: |
#           mkdir changed-sources
#           sf sgd source delta --to "HEAD" --from "HEAD~1" --output changed-sources/ --generate-delta --source force-app/
#           echo "[INFO] Diff generated"
#           ls -R changed-sources

#       - name: Deploy metadata
#         run: |
#           echo "${{ secrets.JWT_SERVER_KEY }}" > server.key
#           sf org login jwt --username ${{ secrets.DEPLOYMENT_USER_NAME }} --jwt-key-file server.key --client-id ${{ secrets.CONSUMER_KEY }} --instance-url ${{ vars.INSTANCE_URL }} --set-default
          
#           if [ -d "changed-sources/force-app" ]; then
#             sf project deploy start --source-dir changed-sources/force-app --test-level RunLocalTests
#           else
#             echo "No metadata changes found — skipping deployment."
#           fi



#  tests starts

# name: Deploy and validate to uat environment

# on:
#   push:
#     branches:
#       - main
#       - feature
#   pull_request:
#     branches: 
#       - main
#     paths:
#       - 'force-app/**'

# jobs:
# # validation job
#   validate-uat:
#       if: github.event_name == 'pull_request'
#       runs-on: ubuntu-latest
#       environment: uat
#       steps:
#           - uses: actions/setup-node@v3    # installs node js in virtual machine 
#             with:
#               node-version: '18'
#           - name: 'Checkout source code'   # clones or Download the repo in the runner machine 
#             uses: actions/checkout@v3
#             with:                          # used for comapring the delta changes
#               fetch-depth: '2'             # it downloads the last two commit which is previous one before the current commit
#                                            # where Head = Latest Commit & Head~1 = previous commit
#           - name: 'Install sfdx'           # installs cli in order to run sf commands 
#             run: npm install @salesforce/cli --global

#           - name: 'Installing sfdx git delta' #sfdx plugins: list all the installed plugins  and this plugins are use to generate delta changes btw two commits
#             run: |                           
#                 echo Y | sfdx plugins:install sfdx-git-delta
#                 sfdx plugins                                           

#           - name: 'Create delta packages'
#             run: | 
#                 mkdir changed-sources
#                 sf sgd source delta --to "HEAD" --from "HEAD~1" --output changed-sources/ --generate-delta --source force-app/ 
#                 echo "[INFO] Diff generated"
                
#           - name: 'validate to environment with running all local tests'
#             run: | 
#                 echo "${{ secrets.JWT_SERVER_KEY }}" > server.key
#                 sf org login jwt --username ${{ secrets.DEPLOYMENT_USER_NAME }} --jwt-key-file server.key --client-id ${{ secrets.CONSUMER_KEY }} --instance-url ${{ vars.INSTANCE_URL }} --set-default --verbose
#                 sf project deploy validate --source-dir changed-sources/force-app --test-level RunLocalTests --verbose --json
# # Deployment job  
#   Deploy-to-uat:
#       if: github.event_name == 'push' && github.ref == 'refs/heads/main'
#       runs-on: ubuntu-latest
#       environment: uat
#       steps:
#           - uses: actions/setup-node@v3
#             with:
#               node-version: '18'
#           - name: 'Checkout source code'
#             uses: actions/checkout@v3
#             with:
#               fetch-depth: '2'
                
#           - name: 'Install sfdx'
#             run: npm install @salesforce/cli --global
#           - name: 'Installing sfdx git delta'
#             run: | 
#                 echo Y | sfdx plugins:install sfdx-git-delta
#                 sfdx plugins

#           - name: 'Create delta packages'
#             run: | 
#                 mkdir changed-sources
#                 sf sgd source delta --to "HEAD" --from "HEAD~1" --output changed-sources/ --generate-delta --source force-app/
#                 echo "[INFO] Diff generated"
                
#           - name: 'Deploy to environment with running all local tests'
#             run: | 
#                 echo "${{ secrets.JWT_SERVER_KEY }}" > server.key
#                 sf org login jwt --username ${{ secrets.DEPLOYMENT_USER_NAME }} --jwt-key-file server.key --client-id ${{ secrets.CONSUMER_KEY }} --instance-url ${{ vars.INSTANCE_URL }} --set-default 
#                 sf project deploy start --source-dir changed-sources/force-app --test-level RunLocalTests 


name: Salesforce CI/CD to UAT Environment

on:
  push:
    branches:
      - feature
      - qa
      - uat
      - main
  pull_request:
    branches:
      - qa
      - uat
      - main
    paths:
      - "force-app/**"

# vars:
#   NODE_VERSION: "18"
#   MIN_CODE_COVERAGE: "75"

jobs:

  # 1. CODE QUALITY JOB
  code-quality:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install Salesforce CLI
        run: npm install @salesforce/cli --global

      - name: Install PMD
        run: |
          echo "Downloading PMD..."
          curl -L -o pmd.zip https://github.com/pmd/pmd/releases/download/pmd_releases%2F7.7.0/pmd-dist-7.7.0-bin.zip
          unzip pmd.zip -d pmd
          echo "PMD extracted:"
          ls -R pmd

      - name: Run Apex PMD Analysis
        run: |
          chmod +x ./pmd/pmd-bin-7.7.0/bin/pmd
          ./pmd/pmd-bin-7.7.0/bin/pmd check \
            -d force-app \
            -R rulesets/apex/quickstart.xml \
            -f text || true 
        
  
  # 2. VALIDATION JOB FOR PULL REQUESTS
  validate:
    needs: [code-quality]
    if: github.event_name == 'pull_request' || (github.event_name == 'push' && (github.ref == 'refs/heads/qa' || github.ref == 'refs/heads/uat' || github.ref == 'refs/heads/main'))
    runs-on: ubuntu-latest
    #environment: uat

    steps:
      - name: Checkout source code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install Salesforce CLI
        run: npm install @salesforce/cli --global

      - name: Install sfdx-git-delta
        run: |
          echo Y | sf plugins install sfdx-git-delta
          sf plugins

      # Correct PR Delta (NO MORE HEAD~1 ISSUES)
      - name: Create Delta for PR Validation
        id: delta_pr
        run: |
          mkdir changed-sources
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # PR SHAs
            FROM="${{ github.event.pull_request.base.sha }}"
            TO="${{ github.event.pull_request.head.sha }}"
          else
            # PUSH SHAs
            TO=$(git rev-parse HEAD)
            FROM=$(git rev-parse HEAD~1)
          fi

          echo "FROM_COMMIT=$FROM"
          echo "TO_COMMIT=$TO"

          sf sgd source delta --to "$TO" --from "$FROM" --output changed-sources/ --generate-delta --source force-app/

          if [ ! -d "changed-sources/force-app" ] || [ -z "$(ls -A changed-sources/force-app)" ]; then
            echo "NO_CHANGES=true" >> $GITHUB_OUTPUT
          else
            echo "NO_CHANGES=false" >> $GITHUB_OUTPUT
          fi

      # Authenticate
      
      - name: Authenticate to Environment
        id: auth
        if: steps.delta_pr.outputs.NO_CHANGES == 'false'
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            TARGET_BRANCH="${{ github.base_ref }}"
          else
             q
          fi
        
          echo "Authenticating based on PR target branch: $TARGET_BRANCH"

          if [ "$TARGET_BRANCH" = "qa" ]; then
            AUTH_URL="${{ secrets.SFDX_AUTH_URL_QA }}"
            ALIAS="QA"
          elif [ "$TARGET_BRANCH" = "uat" ]; then
            AUTH_URL="${{ secrets.SFDX_AUTH_URL_UAT }}"
            ALIAS="UAT"
          elif [ "$TARGET_BRANCH" = "main" ]; then
            AUTH_URL="${{ secrets.SFDX_AUTH_URL_PROD }}"
            ALIAS="PROD"
          else
            echo "ERROR: Unsupported branch: ${{ github.base_ref }}"
            exit 1
          fi
        
          echo "env_alias=$ALIAS" >> $GITHUB_OUTPUT 
          
          echo "$AUTH_URL" > authfile.txt
          sf org login sfdx-url --sfdx-url-file authfile.txt --alias "$ALIAS" --set-default
          rm authfile.txt

      # Validate Deployment

      - name: Validate Delta
        if: steps.delta_pr.outputs.NO_CHANGES == 'false'
        run: |
          ALIAS="${{ steps.auth.outputs.env_alias }}"
          echo "Validating in environment: $ALIAS"

          sf project deploy validate \
            --source-dir changed-sources/force-app \
            --target-org "$ALIAS" \
            --test-level RunLocalTests 

  # 3. DEPLOY TO UAT ON MAIN BRANCH

  Deploy:
    needs: validate
    #needs: [code-quality]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/qa' || github.ref == 'refs/heads/uat' || github.ref == 'refs/heads/main')
    runs-on: ubuntu-latest
    #environment: uat

    steps:
      - name: Checkout full repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup node
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      - name: Install Salesforce CLI
        run: npm install @salesforce/cli --global

      - name: Install sfdx-git-delta
        run: |
          echo Y | sf plugins install sfdx-git-delta
          sf plugins
      
      - name: Set Branch Environment
        id: env
        run: |
          RAW_BRANCH="${GITHUB_REF#refs/heads/}"
          if [[ "$RAW_BRANCH" == "qa" ]]; then
            echo "ORG_AUTH_URL=${{ secrets.SFDX_AUTH_URL_QA }}" >> $GITHUB_OUTPUT
            echo "ENV_NAME=QA" >> $GITHUB_OUTPUT
            echo "DEPLOY_TAG_PREFIX=qa-deployed" >> $GITHUB_OUTPUT
          elif [[ "$RAW_BRANCH" == "uat" ]]; then
            echo "ORG_AUTH_URL=${{ secrets.SFDX_AUTH_URL_UAT }}" >> $GITHUB_OUTPUT
            echo "ENV_NAME=UAT" >> $GITHUB_OUTPUT
            echo "DEPLOY_TAG_PREFIX=uat-deployed" >> $GITHUB_OUTPUT
          elif [[ "$RAW_BRANCH" == "main" ]]; then
            echo "ORG_AUTH_URL=${{ secrets.SFDX_AUTH_URL_PROD }}" >> $GITHUB_OUTPUT
            echo "ENV_NAME=PROD" >> $GITHUB_OUTPUT
            echo "DEPLOY_TAG_PREFIX=prod-deployed" >> $GITHUB_OUTPUT
          else
            echo "ERROR: Unsupported branch $RAW_BRANCH"
            exit 1
          fi

      # Determine Correct Commit Range Using Tags
      # if not tag exists FROM=$(git rev-list --max-parents=0 HEAD) this takes root commit from the head ex: A-->Root Commit B C D-->latest commit  then From Becomes commit A
      # if tags exists FROM=$(git rev-list -n 1 "$LAST_TAG") then checks this tag is related to which commit lets say it was commit A then from Becomes A
      - name: Find last deployment tag
        id: last_tag
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 --match "${{ steps.env.outputs.DEPLOY_TAG_PREFIX}}/*" 2>/dev/null || true)
          if [ -z "$LAST_TAG" ]; then
            FROM=$(git rev-list --max-parents=0 HEAD)    
          else
            FROM=$(git rev-list -n 1 "$LAST_TAG")
          fi

          echo "FROM_COMMIT=$FROM" >> $GITHUB_OUTPUT
          echo "TO_COMMIT=HEAD" >> $GITHUB_OUTPUT

      # Delta for main deployment
      - name: Create delta for deployment
        id: delta_deploy
        run: |
          mkdir changed-sources

          sf sgd source delta \
            --from "${{ steps.last_tag.outputs.FROM_COMMIT }}" \
            --to "HEAD" \
            --output changed-sources/ \
            --generate-delta \
            --source force-app/ 

          if [ ! -d "changed-sources/force-app" ] || [ -z "$(ls -A changed-sources/force-app)" ]; then
            echo "NO_CHANGES=true" >> $GITHUB_OUTPUT
          else
            echo "NO_CHANGES=false" >> $GITHUB_OUTPUT
          fi

      # Authenticate
      - name: Authenticate to UAT
        if: steps.delta_deploy.outputs.NO_CHANGES == 'false'
        run: |
          echo "${{ steps.env.outputs.ORG_AUTH_URL }}" > authfile.txt
          sf org login sfdx-url --sfdx-url-file authfile.txt --alias "${{ steps.env.outputs.ENV_NAME }}" --set-default
          rm authfile.txt
          echo "Authenticated to org: ${{ steps.env.outputs.ENV_NAME }}"  

      # Deploy Delta to UAT
      
      - name: Deploy to UAT
        if: steps.delta_deploy.outputs.NO_CHANGES == 'false'
        run: |
          sf project deploy start \
            --source-dir changed-sources/force-app \
            --target-org "${{ steps.env.outputs.ENV_NAME }}"\
            --test-level RunLocalTests 

      # Tag Deployment
      
      - name: Tag deployment
        if: steps.delta_deploy.outputs.NO_CHANGES == 'false'
        run: |
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "GitHub Actions Bot"

          TAG="${{ steps.env.outputs.DEPLOY_TAG_PREFIX }}/${{ github.sha }}"
          git tag -a "$TAG" -m "Deployed ${{ github.sha }} to ${{ steps.env.outputs.ENV_NAME }}"
          git push origin "$TAG" 

