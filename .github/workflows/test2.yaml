# name: Deployment and validation to production
# on:
#   push:
#     branches:
#       - feature
#       - main
#   pull_request:
#     branches:
#       - main

# jobs:

#   #runs validation when pull request is raised
#   Validation:
#     if: github.event_name == 'pull_request'
#     runs-on: ubuntu-latest
#    # environment: UAT

#     steps:
#       - uses: actions/setup-node@v3
#         with:
#           node-version: '18'
#       - name: 'Checkout source code'
#         uses: actions/checkout@v3
#         with:
#           fetch-depth: '2'

#       - name: 'Install sfdx'
#         run: npm install @salesforce/cli --global

#       - name: 'Installing sfdx git delta'
#         run: | 
#           echo Y | sfdx plugins:install sfdx-git-delta
#           sfdx plugins

#       - name: 'Create delta packages'
#         run: | 
#           mkdir changed-sources
#           sf sgd source delta --to "HEAD" --from "HEAD~1" --output changed-sources/ --generate-delta --source force-app/
#           echo "[INFO] Diff generated"  

#       - name: 'Deploy to environment with running all local tests'
#         run: |
#           echo "${{ secrets.JWT_SERVER_KEY }}" > server.key
#           sf org login jwt --username ${{ secrets.DEPLOYMENT_USER_NAME }} --jwt-key-file server.key --client-id ${{ secrets.CONSUMER_KEY }} --instance-url ${{ vars.INSTANCE_URL }} --set-default
#           sf project deploy start \
#           --source-dir changed-sources/force-app \
#           --test-level RunLocalTests \
#           --dry-run

#   # runs when pull request is resolved and merged 
#   Deployment:
#     if: github.event_name == 'push' && github.ref == 'refs/heads/main'
#     runs-on: ubuntu-latest
#    # environment: UAT

#     steps:
#       - uses: actions/setup-node@v3
#         with:
#           node-version: '18'
#       - name: 'Checkout source code'
#         uses: actions/checkout@v3
#         with:
#           fetch-depth: '2'

#       - name: 'Install sfdx'
#         run: npm install @salesforce/cli --global

#       - name: 'Installing sfdx git delta'
#         run: | 
#           echo Y | sfdx plugins:install sfdx-git-delta
#           sfdx plugins

#       - name: 'Create delta packages'
#         run: | 
#           mkdir changed-sources
#           sf sgd source delta --to "HEAD" --from "HEAD~1" --output changed-sources/ --generate-delta --source force-app/
#           echo "[INFO] Diff generated"  

#       - name: 'Deploy to environment with running all local tests'
#         run: |
#           echo "${{ secrets.JWT_SERVER_KEY }}" > server.key
#           sf org login jwt --username ${{ secrets.DEPLOYMENT_USER_NAME }} --jwt-key-file server.key --client-id ${{ secrets.CONSUMER_KEY }} --instance-url ${{ vars.INSTANCE_URL }} --set-default
#           sf project deploy start --source-dir changed-sources/force-app --test-level RunLocalTests




# name: Deploy to Uat environment on push to main

# on:
#   push:
#     branches: 
#       - feature
#       - main
#   pull_request:
#      branches: 
#       - main

# jobs:
#   validate-to-Uat-environment:
#       if: github.event_name == 'pull_request'
#       runs-on: ubuntu-latest
#       environment: UAT
#       steps:
#           - uses: actions/setup-node@v3
#             with:
#               node-version: '18'
#           - name: 'Checkout source code'
#             uses: actions/checkout@v3
#             with:
#               fetch-depth: '2'
                
#           # Now Install Salesforce CLI
#           - name: 'Install sfdx'
#             run: npm install @salesforce/cli --global
#           - name: 'Installing sfdx git delta'
#             run: | 
#                 echo Y | sfdx plugins:install sfdx-git-delta
#                 sfdx plugins

#           - name: 'Create delta packages'
#             run: | 
#                 mkdir changed-sources
#                 sf sgd source delta --to "HEAD" --from "HEAD~1" --output changed-sources/ --generate-delta --source force-app/
#                 echo "[INFO] Diff generated"
                
#           - name: 'Deploy to environment with running all local tests'
#             run: |
#                 echo "${{ secrets.JWT_SERVER_KEY }}" > server.key
#                 sf org login jwt --username ${{ secrets.DEPLOYMENT_USER_NAME }} --jwt-key-file server.key --client-id ${{ secrets.CONSUMER_KEY }} --instance-url ${{ vars.INSTANCE_URL }} --set-default
#                 sf project deploy validate --source-dir changed-sources/force-app --test-level RunLocalTests


#   Deploy-to-Uat-environment:
#       if: github.event_name == 'push' && github.ref == 'refs/heads/main'
#       runs-on: ubuntu-latest
#       environment: UAT
#       steps:
#           - uses: actions/setup-node@v3
#             with:
#               node-version: '18'
#           - name: 'Checkout source code'
#             uses: actions/checkout@v3
#             with:
#               fetch-depth: '2'
                
#           # Now Install Salesforce CLI
#           - name: 'Install sfdx'
#             run: npm install @salesforce/cli --global
#           - name: 'Installing sfdx git delta'
#             run: | 
#                 echo Y | sfdx plugins:install sfdx-git-delta
#                 sfdx plugins

#           - name: 'Create delta packages'
#             run: | 
#                 mkdir changed-sources
#                 sf sgd source delta --to "HEAD" --from "HEAD~1" --output changed-sources/ --generate-delta --source force-app/
#                 echo "[INFO] Diff generated"
                
#           - name: 'Deploy to environment with running all local tests'
#             run: |
#                 echo "${{ secrets.JWT_SERVER_KEY }}" > server.key
#                 sf org login jwt --username ${{ secrets.DEPLOYMENT_USER_NAME }} --jwt-key-file server.key --client-id ${{ secrets.CONSUMER_KEY }} --instance-url ${{ vars.INSTANCE_URL }} --set-default
#                 sf project deploy start --source-dir changed-sources/force-app --test-level RunLocalTests

# name: Deploy to UAT environment on push to main

# on:
#   push:
#     branches: 
#       - feature
#       - main
#   pull_request:
#     branches: 
#       - main

# jobs:

#   validate-to-Uat-environment:
#     if: github.event_name == 'pull_request'
#     runs-on: ubuntu-latest
#     environment: UAT

#     steps:
#       - uses: actions/setup-node@v3
#         with:
#           node-version: '18'

#       - name: Checkout source code
#         uses: actions/checkout@v3
#         with:
#           fetch-depth: '2'

#       - name: Install sfdx
#         run: npm install @salesforce/cli --global

#       - name: Installing sfdx git delta
#         run: |
#           echo Y | sfdx plugins:install sfdx-git-delta
#           sfdx plugins

#       - name: Create delta packages
#         run: |
#           mkdir changed-sources
#           sf sgd source delta --to "HEAD" --from "HEAD~1" --output changed-sources/ --generate-delta --source force-app/
#           echo "[INFO] Diff generated"
#           ls -R changed-sources

#       - name: Validate deployment
#         run: |
#           echo "${{ secrets.JWT_SERVER_KEY }}" > server.key
#           sf org login jwt --username ${{ secrets.DEPLOYMENT_USER_NAME }} --jwt-key-file server.key --client-id ${{ secrets.CONSUMER_KEY }} --instance-url ${{ vars.INSTANCE_URL }} --set-default
          
#           if [ -d "changed-sources/force-app" ]; then
#             sf project deploy validate --source-dir changed-sources/force-app --test-level RunLocalTests
#           else
#             echo "No metadata changes found — skipping validation."
#           fi


#   Deploy-to-Uat-environment:
#     if: github.event_name == 'push' && github.ref == 'refs/heads/main'
#     runs-on: ubuntu-latest
#     environment: UAT

#     steps:
#       - uses: actions/setup-node@v3
#         with:
#           node-version: '18'

#       - name: Checkout source code
#         uses: actions/checkout@v3
#         with:
#           fetch-depth: '2'

#       - name: Install sfdx
#         run: npm install @salesforce/cli --global

#       - name: Installing sfdx git delta
#         run: |
#           echo Y | sfdx plugins:install sfdx-git-delta
#           sfdx plugins

#       - name: Create delta packages
#         run: |
#           mkdir changed-sources
#           sf sgd source delta --to "HEAD" --from "HEAD~1" --output changed-sources/ --generate-delta --source force-app/
#           echo "[INFO] Diff generated"
#           ls -R changed-sources

#       - name: Deploy metadata
#         run: |
#           echo "${{ secrets.JWT_SERVER_KEY }}" > server.key
#           sf org login jwt --username ${{ secrets.DEPLOYMENT_USER_NAME }} --jwt-key-file server.key --client-id ${{ secrets.CONSUMER_KEY }} --instance-url ${{ vars.INSTANCE_URL }} --set-default
          
#           if [ -d "changed-sources/force-app" ]; then
#             sf project deploy start --source-dir changed-sources/force-app --test-level RunLocalTests
#           else
#             echo "No metadata changes found — skipping deployment."
#           fi



#  tests starts

# name: Deploy and validate to uat environment

# on:
#   push:
#     branches:
#       - main
#       - feature
#   pull_request:
#     branches: 
#       - main
#     paths:
#       - 'force-app/**'

# jobs:
# # validation job
#   validate-uat:
#       if: github.event_name == 'pull_request'
#       runs-on: ubuntu-latest
#       environment: uat
#       steps:
#           - uses: actions/setup-node@v3    # installs node js in virtual machine 
#             with:
#               node-version: '18'
#           - name: 'Checkout source code'   # clones or Download the repo in the runner machine 
#             uses: actions/checkout@v3
#             with:                          # used for comapring the delta changes
#               fetch-depth: '2'             # it downloads the last two commit which is previous one before the current commit
#                                            # where Head = Latest Commit & Head~1 = previous commit
#           - name: 'Install sfdx'           # installs cli in order to run sf commands 
#             run: npm install @salesforce/cli --global

#           - name: 'Installing sfdx git delta' #sfdx plugins: list all the installed plugins  and this plugins are use to generate delta changes btw two commits
#             run: |                           
#                 echo Y | sfdx plugins:install sfdx-git-delta
#                 sfdx plugins                                           

#           - name: 'Create delta packages'
#             run: | 
#                 mkdir changed-sources
#                 sf sgd source delta --to "HEAD" --from "HEAD~1" --output changed-sources/ --generate-delta --source force-app/ 
#                 echo "[INFO] Diff generated"
                
#           - name: 'validate to environment with running all local tests'
#             run: | 
#                 echo "${{ secrets.JWT_SERVER_KEY }}" > server.key
#                 sf org login jwt --username ${{ secrets.DEPLOYMENT_USER_NAME }} --jwt-key-file server.key --client-id ${{ secrets.CONSUMER_KEY }} --instance-url ${{ vars.INSTANCE_URL }} --set-default --verbose
#                 sf project deploy validate --source-dir changed-sources/force-app --test-level RunLocalTests --verbose --json
# # Deployment job  
#   Deploy-to-uat:
#       if: github.event_name == 'push' && github.ref == 'refs/heads/main'
#       runs-on: ubuntu-latest
#       environment: uat
#       steps:
#           - uses: actions/setup-node@v3
#             with:
#               node-version: '18'
#           - name: 'Checkout source code'
#             uses: actions/checkout@v3
#             with:
#               fetch-depth: '2'
                
#           - name: 'Install sfdx'
#             run: npm install @salesforce/cli --global
#           - name: 'Installing sfdx git delta'
#             run: | 
#                 echo Y | sfdx plugins:install sfdx-git-delta
#                 sfdx plugins

#           - name: 'Create delta packages'
#             run: | 
#                 mkdir changed-sources
#                 sf sgd source delta --to "HEAD" --from "HEAD~1" --output changed-sources/ --generate-delta --source force-app/
#                 echo "[INFO] Diff generated"
                
#           - name: 'Deploy to environment with running all local tests'
#             run: | 
#                 echo "${{ secrets.JWT_SERVER_KEY }}" > server.key
#                 sf org login jwt --username ${{ secrets.DEPLOYMENT_USER_NAME }} --jwt-key-file server.key --client-id ${{ secrets.CONSUMER_KEY }} --instance-url ${{ vars.INSTANCE_URL }} --set-default 
#                 sf project deploy start --source-dir changed-sources/force-app --test-level RunLocalTests 

name: Salesforce CI/CD (QA / UAT / PROD)

on:
  push:
    branches:
      - feature
      - qa
      - uat
      - main
  pull_request_target:
    branches:
      - qa
      - uat
      - main
    paths:
      - "force-app/**"

env:
  NODE_VERSION: '18'

jobs:
  code-quality:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Salesforce CLI
        run: npm install @salesforce/cli --global

      - name: Install PMD
        run: |
          curl -L -o pmd.zip https://github.com/pmd/pmd/releases/download/pmd_releases%2F7.7.0/pmd-dist-7.7.0-bin.zip
          unzip pmd.zip -d pmd

      - name: Run Apex PMD (best-effort)
        run: |
          chmod +x ./pmd/pmd-bin-7.7.0/bin/pmd
          ./pmd/pmd-bin-7.7.0/bin/pmd check -d force-app -R rulesets/apex/quickstart.xml -f text || true

  validate:
    needs: [code-quality]
    if: >
      github.event_name == 'pull_request_target'
      || (github.event_name == 'push' && (github.ref == 'refs/heads/qa' || github.ref == 'refs/heads/uat' || github.ref == 'refs/heads/main'))
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout full repository (all history & tags)
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Salesforce CLI
        run: npm install @salesforce/cli --global

      - name: Install sfdx-git-delta
        run: |
          echo Y | sf plugins install sfdx-git-delta
          sf plugins

      - name: Ensure tags & refs are present
        run: |
          # fetch tags and all remote refs so git describe and rev-list work reliably
          git remote set-url origin "$(git config --get remote.origin.url)"
          git fetch --prune --unshallow || true
          git fetch --tags --prune origin || true
          git show-ref --tags || true

      - name: Create Delta for PR Validation
        id: delta_pr
        run: |
          mkdir -p changed-sources
          # Determine SHAs correctly for PR (pull_request_target) or push
          if [ "${{ github.event_name }}" = "pull_request_target" ]; then
            FROM="${{ github.event.pull_request.base.sha }}"
            TO="${{ github.event.pull_request.head.sha }}"
          else
            TO=$(git rev-parse HEAD)
            FROM=$(git rev-parse HEAD~1)
          fi

          echo "FROM_COMMIT=$FROM" >> $GITHUB_OUTPUT
          echo "TO_COMMIT=$TO" >> $GITHUB_OUTPUT

          # Generate delta
          sf sgd source delta --to "$TO" --from "$FROM" --output-dir changed-sources/ --generate-delta --source-dir force-app/ || true

          if [ ! -d "changed-sources/force-app" ] || [ -z "$(ls -A changed-sources/force-app 2>/dev/null)" ]; then
            echo "NO_CHANGES=true" >> $GITHUB_OUTPUT
          else
            echo "NO_CHANGES=false" >> $GITHUB_OUTPUT
          fi

      - name: Decide target env & set auth url
        id: auth_info
        run: |
          # For PR events target branch is pull_request.base.ref
          if [ "${{ github.event_name }}" = "pull_request_target" ]; then
            TARGET_BRANCH="${{ github.event.pull_request.base.ref }}"
          else
            RAW="${{ github.ref }}"
            TARGET_BRANCH="${RAW#refs/heads/}"
          fi
          echo "TARGET_BRANCH=$TARGET_BRANCH" >> $GITHUB_OUTPUT

          if [ "$TARGET_BRANCH" = "qa" ]; then
            echo "ORG_AUTH_URL=${{ secrets.SFDX_AUTH_URL_QA }}" >> $GITHUB_OUTPUT
            echo "ENV_ALIAS=QA" >> $GITHUB_OUTPUT
          elif [ "$TARGET_BRANCH" = "uat" ]; then
            echo "ORG_AUTH_URL=${{ secrets.SFDX_AUTH_URL_UAT }}" >> $GITHUB_OUTPUT
            echo "ENV_ALIAS=UAT" >> $GITHUB_OUTPUT
          elif [ "$TARGET_BRANCH" = "main" ]; then
            echo "ORG_AUTH_URL=${{ secrets.SFDX_AUTH_URL_PROD }}" >> $GITHUB_OUTPUT
            echo "ENV_ALIAS=PROD" >> $GITHUB_OUTPUT
          else
            echo "ERROR=unsupported" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Authenticate to target org (SFDX url)
        id: auth
        if: steps.delta_pr.outputs.NO_CHANGES == 'false'
        run: |
          echo "${{ steps.auth_info.outputs.ORG_AUTH_URL }}" > authfile.txt
          sf org login sfdx-url --sfdx-url-file authfile.txt --alias "${{ steps.auth_info.outputs.ENV_ALIAS }}" --set-default
          rm -f authfile.txt
          echo "env_alias=${{ steps.auth_info.outputs.ENV_ALIAS }}" >> $GITHUB_OUTPUT

      - name: Validate Delta on target org
        if: steps.delta_pr.outputs.NO_CHANGES == 'false'
        run: |
          ALIAS="${{ steps.auth.outputs.env_alias }}"
          echo "Validating in environment: $ALIAS"
          sf project deploy validate --source-dir changed-sources/force-app --target-org "$ALIAS" --test-level RunLocalTests --verbose --json

      - name: Skip validation (no changes)
        if: steps.delta_pr.outputs.NO_CHANGES == 'true'
        run: echo "No metadata changes detected — validation skipped."

  deploy:
    needs: [validate]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/qa' || github.ref == 'refs/heads/uat' || github.ref == 'refs/heads/main')
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - name: Checkout repo (full)
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Salesforce CLI
        run: npm install @salesforce/cli --global

      - name: Install sfdx-git-delta
        run: |
          echo Y | sf plugins install sfdx-git-delta
          sf plugins

      - name: Set branch / env outputs
        id: set_env
        run: |
          RAW_BRANCH="${GITHUB_REF#refs/heads/}"
          if [[ "$RAW_BRANCH" == "qa" ]]; then
            echo "ORG_AUTH_URL=${{ secrets.SFDX_AUTH_URL_QA }}" >> $GITHUB_OUTPUT
            echo "ENV_NAME=QA" >> $GITHUB_OUTPUT
            echo "DEPLOY_TAG_PREFIX=qa-deployed" >> $GITHUB_OUTPUT
          elif [[ "$RAW_BRANCH" == "uat" ]]; then
            echo "ORG_AUTH_URL=${{ secrets.SFDX_AUTH_URL_UAT }}" >> $GITHUB_OUTPUT
            echo "ENV_NAME=UAT" >> $GITHUB_OUTPUT
            echo "DEPLOY_TAG_PREFIX=uat-deployed" >> $GITHUB_OUTPUT
          elif [[ "$RAW_BRANCH" == "main" ]]; then
            echo "ORG_AUTH_URL=${{ secrets.SFDX_AUTH_URL_PROD }}" >> $GITHUB_OUTPUT
            echo "ENV_NAME=PROD" >> $GITHUB_OUTPUT
            echo "DEPLOY_TAG_PREFIX=prod-deployed" >> $GITHUB_OUTPUT
          else
            echo "ERROR=unsupported" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Ensure tags present
        run: |
          git fetch --prune --unshallow || true
          git fetch --tags --prune origin || true

      - name: Find last deployment tag
        id: last_tag
        run: |
          PREFIX="${{ steps.set_env.outputs.DEPLOY_TAG_PREFIX }}"
          # make sure we have tags
          git fetch --tags origin || true
          LAST_TAG=$(git describe --tags --abbrev=0 --match "${PREFIX}/*" 2>/dev/null || true)
          if [ -z "$LAST_TAG" ]; then
            FROM=$(git rev-list --max-parents=0 HEAD)
          else
            FROM=$(git rev-list -n 1 "$LAST_TAG")
          fi
          echo "LAST_TAG=$LAST_TAG" >> $GITHUB_OUTPUT
          echo "FROM_COMMIT=$FROM" >> $GITHUB_OUTPUT
          echo "TO_COMMIT=HEAD" >> $GITHUB_OUTPUT

      - name: Create delta for deployment
        id: delta_deploy
        run: |
          mkdir -p changed-sources
          sf sgd source delta --from "${{ steps.last_tag.outputs.FROM_COMMIT }}" --to "HEAD" --output-dir changed-sources/ --generate-delta --source-dir force-app/ || true
          if [ ! -d "changed-sources/force-app" ] || [ -z "$(ls -A changed-sources/force-app 2>/dev/null)" ]; then
            echo "NO_CHANGES=true" >> $GITHUB_OUTPUT
          else
            echo "NO_CHANGES=false" >> $GITHUB_OUTPUT
          fi

      - name: Authenticate to target org (SFDX url)
        if: steps.delta_deploy.outputs.NO_CHANGES == 'false'
        run: |
          echo "${{ steps.set_env.outputs.ORG_AUTH_URL }}" > authfile.txt
          sf org login sfdx-url --sfdx-url-file authfile.txt --alias "${{ steps.set_env.outputs.ENV_NAME }}" --set-default
          rm -f authfile.txt
          echo "Authenticated to org: ${{ steps.set_env.outputs.ENV_NAME }}"

      - name: Deploy delta to target org
        if: steps.delta_deploy.outputs.NO_CHANGES == 'false'
        run: |
          sf project deploy start --source-dir changed-sources/force-app --target-org "${{ steps.set_env.outputs.ENV_NAME }}" --test-level RunLocalTests --wait 60

      - name: Tag deployment
        if: steps.delta_deploy.outputs.NO_CHANGES == 'false'
        run: |
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "GitHub Actions Bot"
          TAG="${{ steps.set_env.outputs.DEPLOY_TAG_PREFIX }}/${{ github.sha }}"
          git tag -a "$TAG" -m "Deployed ${{ github.sha }} to ${{ steps.set_env.outputs.ENV_NAME }}"
          git push origin "$TAG"
