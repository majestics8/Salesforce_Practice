name: Auto Promote Feature Branch

on:
  pull_request:
    types:
      - closed
    branches:
      - qa
      - uat

jobs:
  promote:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Get PR info
      id: info
      run: |
        SOURCE="${{ github.event.pull_request.head.ref }}"
        TARGET="${{ github.event.pull_request.base.ref }}"

        echo "SOURCE=$SOURCE"  >> $GITHUB_OUTPUT
        echo "TARGET=$TARGET"  >> $GITHUB_OUTPUT

        # HEAD must always be "feature"
        if [[ "$SOURCE" != feature* ]]; then
          echo "Not a feature branch — skipping"
          echo "NEXT=" >> $GITHUB_OUTPUT
          exit 0
        fi

        # Decide next target
        if [ "$TARGET" = "qa" ]; then
          NEXT="uat"
        elif [ "$TARGET" = "uat" ]; then
          NEXT="main"
        else
          NEXT=""
        fi

        echo "NEXT=$NEXT" >> $GITHUB_OUTPUT

    - name: Create next PR
      if: steps.info.outputs.NEXT != ''
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SOURCE: ${{ steps.info.outputs.SOURCE }}
        TARGET: ${{ steps.info.outputs.TARGET }}
        NEXT: ${{ steps.info.outputs.NEXT }}
      run: |
        echo "Creating PR: ${SOURCE} → ${NEXT}"

        gh pr create \z
          --title "Auto Promotion: ${SOURCE} → ${NEXT}" \
          --body "This PR was automatically created after merging ${SOURCE} into ${TARGET}." \
          --base "${NEXT}" \
          --head "${SOURCE}" \
          || echo "PR already exists, skipping..."

  Validation:
    runs-on: ubuntu-latest

    steps:
      - name: create repo on virtual machine
        uses: actions/checkout@v3

      - name: Fetch full git history
        run: |
          git fetch --unshallow || git fetch --all

      - name: Node setup
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install Salesforce CLI
        run: npm install @salesforce/cli --global

      - name: Install PMD to scan apex code
        run: |
          echo "Downloading PMD..."
          curl -L -o pmd.zip https://github.com/pmd/pmd/releases/download/pmd_releases%2F7.7.0/pmd-dist-7.7.0-bin.zip
          unzip pmd.zip -d pmd
          echo "PMD extracted:"
          ls -R pmd
          
      - name: Install xmllint
        run: sudo apt-get update && sudo apt-get install -y libxml2-utils

      - name: Delta plugins download
        run: |
          echo Y | sf plugins install sfdx-git-delta
          sf plugins

      - name: creating delta changes for validation
        id: delta
        run: |
          SRC_BRANCH="${{ github.event.pull_request.head.ref }}"
          TARGET_BRANCH="${{ github.event.pull_request.base.ref }}"
          
          echo "SOURCE BRANCH = $SRC_BRANCH"
          echo "TARGET BRANCH = $TARGET_BRANCH"

          if [ "$TARGET_BRANCH" = "qa" ]; then
            DELTA_TARGET="uat"
          elif [ "$TARGET_BRANCH" = "uat" ]; then
            DELTA_TARGET="main"
          fi

          echo "Delta will be generated against: $DELTA_TARGET"
          
          echo "Fetching remote branch: $DELTA_TARGET"
          git fetch origin "$DELTA_TARGET:$DELTA_TARGET"

          SRC_COMMIT="${{ github.event.pull_request.head.sha }}"
          TGT_COMMIT=$(git rev-parse $DELTA_TARGET)

          if ! git cat-file -e $TGT_COMMIT^{commit}; then
            echo "Falling back to merge-base method"

            MERGE_BASE=$(git merge-base $SRC_BRANCH $DELTA_TARGET)
            FROM_COMMIT=$MERGE_BASE
            TO_COMMIT=$(git rev-parse $SRC_BRANCH)
          else
            FROM_COMMIT=$TGT_COMMIT
            TO_COMMIT=$SRC_COMMIT
          fi
         
          echo "Using FROM_COMMIT=$FROM_COMMIT TO_COMMIT=$TO_COMMIT"

          rm -rf delta
          mkdir -p delta

          echo "Running delta creation command"
          sf sgd source delta --to "$TO_COMMIT" --from "$FROM_COMMIT" --output delta/ --generate-delta --source force-app/main/default

          echo "Delta structure:"
          tree delta || ls -R delta
        
          echo "--- Generated package.xml ---"
          if [[ -f delta/package/package.xml  && -d "delta/force-app" ]]; then
            cat delta/package/package.xml
            echo "NO_CHANGES=false" >> $GITHUB_OUTPUT
          else
            echo "Either No package.xml or force-app found. Probably no deployable changes."
            echo "NO_CHANGES=true" >> $GITHUB_OUTPUT
          fi

      - name: Run Pmd Scan For Generated Delta
        run: |
          chmod +x ./pmd/pmd-bin-7.7.0/bin/pmd
          ./pmd/pmd-bin-7.7.0/bin/pmd check \
            -d delta \
            -R rulesets/apex/quickstart.xml \
            -f text || true 
             
      - name: Authenticate to Environment
        id: auth
        if: steps.delta.outputs.NO_CHANGES == 'false'
        run: |
          TARGET_BRANCH="${{ github.event.pull_request.base.ref }}"

          if [ "$TARGET_BRANCH" = "qa" ]; then
            AUTH_URL="${{ secrets.SFDX_AUTH_URL_UAT }}"
            ALIAS="UAT"
            BRANCH="uat"
          elif [ "$TARGET_BRANCH" = "uat" ]; then
            AUTH_URL="${{ secrets.SFDX_AUTH_URL_PROD }}"
            ALIAS="PROD"
            BRANCH="main"
          elif [ "$TARGET_BRANCH" = "main" ]; then
            AUTH_URL="${{ secrets.SFDX_AUTH_URL_PROD }}"
            ALIAS="PROD"
            BRANCH="main"
          else
            echo "ERROR: Unsupported branch: ${{ github.event.pull_request.base.ref }}"
            exit 1
          fi

          echo "env_alias=$ALIAS" >> $GITHUB_OUTPUT 

          echo "Authenticating based on PR target branch: $BRANCH"

          echo "$AUTH_URL" > authfile.txt
          sf org login sfdx-url --sfdx-url-file authfile.txt --alias "$ALIAS" --set-default
          rm authfile.txt

      # Validate Deployment

      - name: Extract all Test Classes
        id: tests
        run: |
          TEST_LIST=""
          echo "=== Extracting Apex Classes from delta package.xml ==="

          APEX_CLASSES=$(xmllint --xpath \
            "//*[local-name()='types'][*[local-name()='name']='ApexClass']/*[local-name()='members']/text()" \
            delta/package/package.xml)

          echo "Changed Apex Classes:"
          echo "$APEX_CLASSES"

          for CLASS in $APEX_CLASSES; do
            echo "--------------------------------------"
            echo "Processing Apex Class: $CLASS"

            REGEX="^${CLASS}([A-Za-z0-9_]*)(test)$"
            echo "Test class matching regex: $REGEX"

            TESTS_IN_DELTA=$(xmllint --xpath \
              "//*[local-name()='types'][*[local-name()='name']='ApexClass']/*[local-name()='members']/text()" \
              delta/package/package.xml | grep -Ei "$REGEX" || true)

            if [ -n "$TESTS_IN_DELTA" ]; then
              echo "✔ Found in delta: $TESTS_IN_DELTA"
              TEST_LIST="$TEST_LIST $TESTS_IN_DELTA"
              continue
            fi

            TESTS_IN_REPO=$(find force-app -type f -name "*.cls" \
              | sed 's/.*\///;s/\.cls//' \
              | grep -Ei "$REGEX" || true)

            if [ -n "$TESTS_IN_REPO" ]; then
              echo "✔ Found in repo: $TESTS_IN_REPO"
              TEST_LIST="$TEST_LIST $TESTS_IN_REPO"
              continue
            fi
            
            if [[ "$CLASS" =~ [Tt]est$ || "$CLASS" =~ [Tt]ests$ || "$CLASS" =~ [Tt]est[Cc]lass$ ]]; then
              DEFAULT="$CLASS"
            else
              DEFAULT="${CLASS}Test"
            fi

            echo "⚠ No test found — using fallback: $DEFAULT"
            TEST_LIST="$TEST_LIST $DEFAULT"
          done

          echo "--------------------------------------"
          echo "FINAL TEST LIST:"
          echo "$TEST_LIST"

          echo "TEST_LIST=$TEST_LIST" >> $GITHUB_OUTPUT

      # Validate Deployment
      - name: Validate Delta
        if: steps.delta.outputs.NO_CHANGES == 'false'
        run: |
          ALIAS="${{ steps.auth.outputs.env_alias }}"
          echo "Validating in environment: $ALIAS"

          ALL_TESTS="${{ steps.tests.outputs.TEST_LIST }}"

          echo "Found Test Classes: $ALL_TESTS"
          
          TEST_PARAMS=""

          for t in $ALL_TESTS; do
            CLEAN=$(echo "$t" | awk '{$1=$1;print}')
            TEST_PARAMS="$TEST_PARAMS --tests $CLEAN"
          done

          echo "Final TEST_PARAMS: $TEST_PARAMS"
          
          if [ -n "$ALL_TESTS" ]; then
            echo "Executing validation using RunSpecifiedTests"
            eval sf project deploy start \
              -x delta/package/package.xml \
              -o "$ALIAS" \
              --dry-run \
              -l RunSpecifiedTests \
              $TEST_PARAMS
          else
            echo "No test classes found — Running NoTestRun"
            sf project deploy start \
              -x delta/package/package.xml \
              -o "$ALIAS" \
              --dry-run \
              -l NoTestRun
          fi
        

        

         
          
